<script type="text/javascript" src="resources/node-red-contrib-refined-motion/camera-controller.js" />

<script type="text/html" data-template-name="camera-server">
    <div class="form-row">
        <label for="node-config-input-host"><i class="fa fa-link" ></i> Host : Port</label>
        <input type="text" id="node-config-input-host" placeholder="host">
    </div>
</script>

<script type="text/html" data-help-name="camera-server">
    <p>Camera Location</p>
</script>

<script type="text/html" data-template-name="set-camera-config">
    <div class="form-row">
        <label for="node-input-camlocation"><i class="fa fa-link" ></i>Cam Location</label>
        <select id="node-input-camlocation" ></select>
    </div>
    <div class="form-row">
        <label for="node-input-camera"><i class="fa fa-camera" ></i>Target Cam</label>
        <select id="node-input-camera" ></select>
    </div>
    <div class="form-row">
        <label for="node-input-camprop"><i class="fa fa-tag" ></i>Cam Property</label>
        <select id="node-input-camprop" ></select>
    </div>
    <div class="form-row">
        <label for="node-input-propval"><i class="fa fa-outdent" ></i>Property Value</label>
        <select id="node-input-propval" ></select>
    </div>
</script>

<script type="text/html" data-help-name="set-camera-config">
    <p>Camera Property Options</p>
    <div id="camPropertyDesc"></div>
</script>

<script type="text/javascript">
    (function () {

        const camController = new CameraController($)

        RED.nodes.registerType('camera-server', {
            category: 'config',
            paletteLabel:'Camera Server',
            defaults: {
                host: {value: "http://127.0.0.1:1880", required: true}
            },
            inputs: 0,
            outputs: 0,
            label: function () {
                return this.host;
            },
            oneditsave: function () {
                $('#node-input-camera').addClass('loading');
                setTimeout(async () => {
                    var host = $('#node-input-camlocation option:selected').text();
                    if (!host || host.indexOf('http') !== 0) {
                        console.warn("Select a Camera Server " + host);
                        return false;  // TODO: retry?
                    }
                    console.log("CamServer Timeout: " + host)
                    camController.setHost(host);
                    await camController.loadCameras(true);
                    camController.renderCameras();

                    if (camController.cam) {
                        await camController.loadCamConfigs()
                        camController.renderCamProps();
                    }

                }, 500)
            }
        });

        RED.nodes.registerType('set-camera-config', {
            category: 'Flexible Vision',
            paletteLabel:'Configure Camera',
            color: '#de7f7f',
            defaults: {
                camlocation: {type: "camera-server", required: true},
                camera: {value: "", required: true},
                camprop: {value: "", required: true},
                propval: {value: "", required: true, inputLabels:camController.getToolTip},
            },
            inputs: 1,
            outputs: 1,
            icon: "outline-visibility-24px.svg",
            label: function () {
                let parts = [];
                if (this.camprop != "") parts.push(this.camprop);
                if (this.propval != "") parts.push(this.propval);
                if (parts.length === 0) parts.unshift(this._def.paletteLabel);
                else if (parts.length === 1) parts.unshift("Config");
                return parts.join(' - ');
            },
            oneditprepare: function () {
                console.log("set-camera-config oneditprepare");

                $('#node-input-camera').change(async (e) => {
                    let camId = $(e).val();
                    console.log("CAM CHANGED: " + camId, $(e).get(0));
                    if (camId && camId !== '') {
                        camController.setCam(camId);
                        await camController.loadCamConfigs()
                        camController.renderCamProps();
                    }
                });

                $('#node-input-camprop').change((e) => {
                    let selected = $('#node-input-camprop option:selected');
                    console.log("CAMPROPs CHANGED", selected);
                    if (selected.length === 0) {
                        console.warn("NOTHING SELECTED", e);
                        return false;
                    }
                    // let toPass = camController.getAllAttributes(selected.get(0));
                    camController.setProperty(selected.attr('data-parent'), selected.attr('value'))
                    camController.buildPropValField()
                });
            }
        });
    })();
</script>
