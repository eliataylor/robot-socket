<script type="text/html" data-template-name="camserver">
    <div class="form-row">
        <label for="node-config-input-host"><i class="fa fa-link" aria-hidden="true"></i> Host : Port</label>
        <input type="text" id="node-config-input-host" placeholder="host">
    </div>
</script>

<script type="text/html" data-help-name="cameras">
    <p>Camera Location</p>
</script>

<script type="text/html" data-template-name="set-camera-config">
    <div class="form-row">
        <label for="node-input-camserver"><i class="fa fa-link" ></i>Cam Location</label>
        <input type="text" id="node-input-camserver" >
    </div>
    <div class="form-row">
        <label for="node-input-camera"><i class="fa fa-camera" ></i>Target Cam</label>
        <select type="text" id="node-input-camera" ></select>
    </div>
    <div class="form-row">
        <label for="node-input-camprop"><i class="fa fa-outdent" ></i>Cam Property</label>
        <select type="text" id="node-input-camprop" ></select>
    </div>
    <div class="form-row">
        <label for="node-input-propval"><i class="fa fa-outdent" ></i>Property Value</label>
        <select type="text" id="node-input-propval" ></select>
    </div>
</script>

<script type="text/html" data-help-name="set-camera-config">
    <p>finds trained objects from uploaded</p>
</script>


<script type="text/javascript">
    (function () {

        const getAllAttributes = el => el
            .getAttributeNames()
            .reduce((obj, name) => ({
                ...obj,
                [name]: el.getAttribute(name)
            }), {})

        const PreloadCameras = function (host) {
            console.log("PreloadCameras", host);

            // var url = host + '/vision/cameras';
            var url = "/static/api/cameras.json"; // "resources/camera-tools/api/cameras.json";

            let cameras = localStorage.getItem('flexV-'+host+'-Cameras')
            if (cameras) {
                cameras = JSON.parse(cameras);
                console.log("LS", cameras);
                $('#node-input-camera').html('');
                return cameras.forEach(o => {
                    $('<option/>', {
                        'value': o.id,
                        'text': o.user_defined_name
                    }).appendTo('#node-input-camera');
                })
            }

            $('#node-input-camera').html('<option>Please Wait. Loading cameras...</option>');

            $.ajax({
                url: url,
                dataType: "json"
            }).done(function (data) {
                console.log("Got Cameras from " + host, data);
                localStorage.setItem('flexV-'+host+'-Cameras', JSON.stringify(data))

                $('#node-input-camera').html('');
                data.forEach(o => {
                    $('<option/>', {
                        'value': o.id,
                        'text': o.user_defined_name
                    }).appendTo('#node-input-camera');
                })
            }).error(function (err) {
                $('#node-input-camera').html('Error loading cameras');
                console.log(err);
            });
        }

        const PreloadCamConfigs = function (camId) {
            var host = $('#node-input-camserver option:selected').text();
            if (!host || host.indexOf('http') !== 0) {
                console.log("PreloadCamConfigs: Select a Camera Server " + host, this);
                return false;
            }

            var url = host + '/api/vision/vision/configTree/' + camId;
            url = "/static/api/configTree.json?camId=" + camId;

            $('#node-input-camprop').html('<option>Please Wait. Loading Camera Config Tree...</option>');

            $.ajax({
                url: url,
                dataType: "json"
            }).done(function (data) {
                console.log("Got Config Tree:", data);
                let allTypes = {}
                $('#node-input-camprop').html('');
                let parents = {};
                for(let parent in data) {
                    if (!parents[parent]) {
                        $('<option/>', {
                            'text': parent,
                            'disabled':true
                        }).appendTo('#node-input-camprop');
                        parents[parent] = true;
                    }
                    for(let selector in data[parent]) {
                        allTypes[data[parent][selector].type] = true;
                        var toPass = {}
                        for (let p in data[parent][selector]) {
                            toPass['data-'+p] = data[parent][selector][p];
                        }
                        toPass.value = data[parent][selector].value;
                        toPass.text = selector;
                        toPass['data-parent'] = parent;
                        $('<option/>', toPass).appendTo('#node-input-camprop');
                    }
                }
                console.info(Object.keys(allTypes));
            }).error(function (err) {
                $('#node-input-camprop').html('Error loading cameras');
                console.error(err);
            });
        }

        BuildPropValField = function($opt)  {
            // TODO: handle: ['Enumerate', 'String', 'Integer', 'Float', 'Command', 'Bool', 'null']
            console.log("BUILD ", $opt);
            $('#node-input-propval').html('');
        }

        RED.nodes.registerType('camserver', {
            category: 'config',
            paletteLabel:'Camera Server',
            defaults: {
                host: {value: "http://127.0.0.1:1880", required: true}
            },
            inputs: 0,
            outputs: 0,
            label: function () {
                return this.host;
            },
            oneditsave: function () {
                $('#node-input-camera').addClass('loading');
                setTimeout(() => {
                    var host = $('#node-input-camserver option:selected').text();
                    if (!host || host.indexOf('http') !== 0) {
                        console.warn("Select a Camera Server " + host);
                        return false;  // TODO: retry?
                    }
                    console.log("CAMSERVER timeout: ", host)
                    PreloadCameras(host);
                    $('#node-input-camera').removeClass('loading');
                }, 500)
            }
        });

        RED.nodes.registerType('set-camera-config', {
            category: 'FlexibleAssembly',
            paletteLabel:'Configure Camera',
            color: '#de7f7f',
            defaults: {
                camera: {value: "", required: true},
                camprop: {value: "", required: true},
                propval: {value: "", required: true},
                camserver: {type: "camserver", required: true}
            },
            inputs: 1,
            outputs: 1,
            icon: "outline-visibility-24px.svg",
            label: function () {
                let parts = [];
                if (this.camprop != "") parts.push(this.camprop);
                if (this.propval != "") parts.push(this.propval);
                if (parts.length === 0) parts.unshift(this._def.paletteLabel);
                else if (parts.length === 1) parts.unshift("Config");
                return parts.join(' - ');
            },
            oneditprepare: function () {
                debugger;
                console.log("set-camera-config oneditprepare", this);

                $('#node-input-camera').change(function () {
                    PreloadCamConfigs($(this).val())
                });

                if (this.camprop && this.camprop.length > 0) {
                    // disabled??
                }

                $('#node-input-camprop').change(function () {
                    let selected = $(this).find("option:selected");
                    if (selected.length === 0) {
                        return false;
                    }
                    console.log(selected, selected.get(0));
                    debugger;
                    let toPass = getAllAttributes(selected.get(0));
                    BuildPropValField(toPass)
                });

            }
        });
    })();
</script>
